<!doctype html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="theme-color" content="#14b8a6" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <link rel="manifest" href="/manifest.json" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="preconnect" href="https://connect.facebook.net" />
        <title>Graver.uz</title>

        <!-- Block Stape at fetch level BEFORE anything loads -->
        <script>
        // Override fetch to block Stape requests
        var originalFetch = window.fetch;
        window.fetch = function(resource, config) {
          var url = typeof resource === 'string' ? resource : resource.url;
          
          // Block all Stape requests
          if (url && (
            url.includes('camie.stape.bg') ||
            url.includes('sgw.stape.bg') ||
            url.includes('capig.stape.ma') ||
            url.includes('stape.bg') ||
            url.includes('stape.ma')
          )) {
            console.log('[Stape Blocker] Blocked fetch to:', url);
            // Return a rejected promise to simulate network error
            return Promise.reject(new TypeError('Stape blocked'));
          }
          
          return originalFetch.apply(this, arguments);
        };
        
        // Override XMLHttpRequest to block Stape
        var originalXHROpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url) {
          if (url && (
            url.includes('camie.stape.bg') ||
            url.includes('sgw.stape.bg') ||
            url.includes('capig.stape.ma') ||
            url.includes('stape.bg') ||
            url.includes('stape.ma')
          )) {
            console.log('[Stape Blocker] Blocked XHR to:', url);
            // Mark as blocked
            this.__stapeBlocked = true;
            return;
          }
          return originalXHROpen.apply(this, arguments);
        };
        
        // Override XMLHttpRequest.send to prevent blocked requests
        var originalXHRSend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.send = function() {
          if (this.__stapeBlocked) {
            console.log('[Stape Blocker] Blocked XHR send');
            return;
          }
          return originalXHRSend.apply(this, arguments);
        };
        
        // Initialize dataLayer BEFORE GTM loads
        window.dataLayer = window.dataLayer || [];
        </script>

        <!-- Meta Pixel Code -->
        <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '1358428289305229');
        fbq('track', 'PageView');
        </script>
        <noscript><img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1358428289305229&ev=PageView&noscript=1"
        /></noscript>
        <!-- End Meta Pixel Code -->

    </head>
    <body>
        <noscript>You need to enable JavaScript to run this app.</noscript>
        <div id="root"></div>

        <!-- Service Worker Disabled in Production -->
        <script>
        (function() {
          if (!('serviceWorker' in navigator)) return;

          var host = window.location.hostname;
          var isProdHost = [
            'graver-studio.uz',
            'graver.uz',
            'www.graver.uz'
          ].indexOf(host) !== -1;
          var forceKill = window.location.search.indexOf('sw-kill=1') !== -1;

          if (!isProdHost && !forceKill) return;

          navigator.serviceWorker.getRegistrations()
            .then(function(regs) {
              regs.forEach(function(reg) {
                reg.unregister();
              });
            })
            .catch(function() {});

          if ('caches' in window) {
            caches.keys()
              .then(function(keys) {
                keys.forEach(function(key) {
                  caches.delete(key);
                });
              })
              .catch(function() {});
          }
        })();
        </script>
    </body>
</html>
