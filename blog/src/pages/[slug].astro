---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const siteUrl = 'https://gifting-hub-16.preview.emergentagent.com';
const mainSiteUrl = 'https://gifting-hub-16.emergent.host';
const telegramLink = 'https://t.me/GraverAdm';
const whatsappLink = 'https://wa.me/998770802288';

// Breadcrumbs
const breadcrumbs = [
  { name: 'Главная', url: siteUrl },
  { name: post.data.category, url: `${siteUrl}/category/${encodeURIComponent(post.data.category.toLowerCase())}` },
  { name: post.data.title, url: `${siteUrl}/${post.slug}` }
];

// Related posts
const allPosts = await getCollection('posts');
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug)
  .filter(p => 
    p.data.category === post.data.category || 
    p.data.tags.some(t => post.data.tags.includes(t))
  )
  .slice(0, 3);

// Generate TOC from content (simple version)
const headings = post.body.match(/^##\s+(.+)$/gm) || [];
const toc = headings.map(h => ({
  text: h.replace(/^##\s+/, ''),
  id: h.replace(/^##\s+/, '').toLowerCase().replace(/[^\wа-яё]/gi, '-').replace(/-+/g, '-')
}));
---

<BaseLayout 
  title={`${post.data.title} | Graver.uz`}
  description={post.data.excerpt}
  image={post.data.coverImage ? `${siteUrl}${post.data.coverImage}` : undefined}
  article={{
    publishedAt: post.data.publishedAt,
    updatedAt: post.data.updatedAt,
    author: post.data.author,
    category: post.data.category,
    tags: post.data.tags
  }}
  breadcrumbs={breadcrumbs}
  faq={post.data.faq}
>
  <article class="container" style="padding: 48px 20px;">
    <!-- Breadcrumbs -->
    <nav class="breadcrumbs">
      <a href="/">Блог</a>
      <span>›</span>
      <a href={`/category/${encodeURIComponent(post.data.category.toLowerCase())}`}>{post.data.category}</a>
      <span>›</span>
      <span>{post.data.title.slice(0, 50)}...</span>
    </nav>
    
    <!-- Article Header -->
    <header class="article-header">
      <div class="article-meta">
        <span class="category">{post.data.category}</span>
        <span>{new Date(post.data.publishedAt).toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
        <span>Автор: {post.data.author}</span>
      </div>
      <h1 class="article-title">{post.data.title}</h1>
      <p class="article-excerpt">{post.data.excerpt}</p>
    </header>
    
    <!-- CTA Top -->
    <div class="cta-box">
      <h3>Нужен расчёт для вашего тиража?</h3>
      <p>Отправьте логотип, укажите количество и дедлайн — мы подготовим макет и смету</p>
      <div class="cta-buttons">
        <a href={`${mainSiteUrl}/#contact`} class="cta-primary" target="_blank">Получить макет и расчёт</a>
        <a href={telegramLink} class="cta-secondary" target="_blank">Написать в Telegram</a>
      </div>
    </div>
    
    <!-- TOC -->
    {toc.length > 0 && (
      <nav class="toc">
        <h4>Содержание статьи</h4>
        <ul>
          {toc.map(item => (
            <li><a href={`#${item.id}`}>{item.text}</a></li>
          ))}
        </ul>
      </nav>
    )}
    
    <!-- Article Content -->
    <div class="article-content">
      <Content />
    </div>
    
    <!-- FAQ Section -->
    {post.data.faq && post.data.faq.length > 0 && (
      <section class="faq-section">
        <h2>Часто задаваемые вопросы</h2>
        {post.data.faq.map(item => (
          <details class="faq-item">
            <summary class="faq-question">{item.question}</summary>
            <div class="faq-answer">{item.answer}</div>
          </details>
        ))}
      </section>
    )}
    
    <!-- CTA Bottom -->
    <div class="cta-box">
      <h3>Как заказать корпоративные подарки с гравировкой</h3>
      <p><strong>3 простых шага:</strong> Отправьте логотип, тираж и дедлайн → Получите макет для согласования → Запускаем производство</p>
      <div class="cta-buttons">
        <a href={`${mainSiteUrl}/#contact`} class="cta-primary" target="_blank">Получить макет и расчёт</a>
        <a href={whatsappLink} class="cta-secondary" target="_blank">WhatsApp</a>
      </div>
    </div>
    
    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="related-posts">
        <h3>Читайте также</h3>
        <div class="related-grid">
          {relatedPosts.map(related => (
            <a href={`/${related.slug}`} class="related-card">
              <h4>{related.data.title}</h4>
              <p>{related.data.excerpt.slice(0, 100)}...</p>
            </a>
          ))}
        </div>
      </section>
    )}
    
    <!-- Tags -->
    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #222;">
      <span style="color: #888; font-size: 0.9rem;">Теги: </span>
      {post.data.tags.map((tag, i) => (
        <>
          <a href={`/tag/${encodeURIComponent(tag.toLowerCase())}`} style="font-size: 0.9rem;">{tag}</a>
          {i < post.data.tags.length - 1 && <span style="color: #444;">, </span>}
        </>
      ))}
    </div>
  </article>
</BaseLayout>
